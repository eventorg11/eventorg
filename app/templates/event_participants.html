{% extends 'base.html' %}
{% load static %}

{% block title %}Участники мероприятия - {{ conference.title }}{% endblock %}

{% block content %}
<div class="profile-section">
    <div class="container">
        <div class="profile-content">
            <div class="participants-header">
                <div>
                    <h1 class="page-title">Участники: {{ conference.title }}</h1>
                    <p class="participants-count">
                        Зарегистрировано: {{ registration_count }}{% if max_participants %}/{{ max_participants }}{% endif %}
                    </p>
                </div>
                <a href="{% url 'profile' %}" class="btn btn-secondary">← Назад</a>
            </div>

            <div class="registrations-card">
                {% if registrations %}
                <div class="participants-list">
                    <table class="participants-table">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Имя</th>
                                <th>Фамилия</th>
                                <th>Имя пользователя</th>
                                <th>Email</th>
                                <th>Дата регистрации</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registration in registrations %}
                            <tr data-registration-id="{{ registration.id }}">
                                <td>{{ forloop.counter }}</td>
                                <td>{{ registration.user.first_name|default:"—" }}</td>
                                <td>{{ registration.user.last_name|default:"—" }}</td>
                                <td>{{ registration.user.username }}</td>
                                <td>{{ registration.user.email|default:"—" }}</td>
                                <td>{{ registration.created_at|date:"d.m.Y H:i" }}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm remove-participant-btn" 
                                            data-registration-id="{{ registration.id }}"
                                            data-user-name="{{ registration.user.first_name }} {{ registration.user.last_name }}"
                                            data-username="{{ registration.user.username }}">
                                        Удалить
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-registrations">
                    <p class="no-registrations-message">На данное мероприятие еще никто не зарегистрировался.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="confirmDialog" class="custom-dialog" style="display: none;">
    <div class="custom-dialog-content">
        <div class="custom-dialog-header">
            <h3 class="custom-dialog-title">Подтверждение удаления</h3>
            <button class="custom-dialog-close" onclick="closeConfirmDialog()">×</button>
        </div>
        <div class="custom-dialog-body">
            <p class="custom-dialog-message" id="confirmMessage"></p>
        </div>
        <div class="custom-dialog-footer">
            <button class="btn btn-secondary" onclick="closeConfirmDialog()">Отмена</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
        </div>
    </div>
</div>

<div id="messageDialog" class="custom-dialog" style="display: none;">
    <div class="custom-dialog-content">
        <div class="custom-dialog-header">
            <h3 class="custom-dialog-title" id="messageTitle"></h3>
            <button class="custom-dialog-close" onclick="closeMessageDialog()">×</button>
        </div>
        <div class="custom-dialog-body">
            <p class="custom-dialog-message" id="messageText"></p>
        </div>
        <div class="custom-dialog-footer">
            <button class="btn btn-primary" onclick="closeMessageDialog()">ОК</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.participants-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.page-title {
    color: var(--primary-color);
    font-size: 1.8rem;
    font-weight: 600;
    margin: 0 0 5px 0;
}

.participants-count {
    color: var(--text-color);
    font-size: 1rem;
    margin: 0;
}

.participants-list {
    overflow-x: auto;
}

.participants-table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--bg-white);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.participants-table thead {
    background-color: var(--primary-color);
    color: white;
}

.participants-table th {
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
}

.participants-table tbody tr {
    border-bottom: 1px solid #e0e0e0;
    transition: background-color 0.2s;
}

.participants-table tbody tr:hover {
    background-color: #f5f5f5;
}

.participants-table tbody tr:last-child {
    border-bottom: none;
}

.participants-table td {
    padding: 12px 15px;
    color: var(--text-color);
    font-size: 0.9rem;
}

.participants-table tbody tr:nth-child(even) {
    background-color: #fafafa;
}

.participants-table tbody tr:nth-child(even):hover {
    background-color: #f0f0f0;
}
</style>
{% endblock %}

{% block extra_js %}
{% csrf_token %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let currentRegistrationId = null;

function showConfirmDialog(registrationId, userName, username) {
    currentRegistrationId = registrationId;
    const displayName = userName.trim() || username;
    document.getElementById('confirmMessage').textContent = 
        `Вы уверены, что хотите удалить регистрацию пользователя "${displayName}"?`;
    document.getElementById('confirmDialog').style.display = 'flex';
}

function closeConfirmDialog() {
    document.getElementById('confirmDialog').style.display = 'none';
    currentRegistrationId = null;
}

function showMessageDialog(title, message) {
    document.getElementById('messageTitle').textContent = title;
    document.getElementById('messageText').textContent = message;
    document.getElementById('messageDialog').style.display = 'flex';
}

function closeMessageDialog() {
    document.getElementById('messageDialog').style.display = 'none';
    if (currentRegistrationId === null) {
        location.reload();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.remove-participant-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const registrationId = this.getAttribute('data-registration-id');
            const userName = this.getAttribute('data-user-name');
            const username = this.getAttribute('data-username');
            showConfirmDialog(registrationId, userName, username);
        });
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!currentRegistrationId) return;

        const registrationId = currentRegistrationId;
        const csrftoken = getCookie('csrftoken');

        fetch(`/events/participants/remove/${registrationId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            closeConfirmDialog();
            if (data.success) {
                const row = document.querySelector(`tr[data-registration-id="${registrationId}"]`);
                if (row) {
                    row.remove();
                }
                currentRegistrationId = null;
                showMessageDialog('Успешно', data.message);
            } else {
                showMessageDialog('Ошибка', data.error || 'Произошла ошибка при удалении регистрации');
            }
        })
        .catch(error => {
            closeConfirmDialog();
            showMessageDialog('Ошибка', 'Произошла ошибка при удалении регистрации');
        });
    });

    document.getElementById('confirmDialog').addEventListener('click', function(e) {
        if (e.target === this) {
            closeConfirmDialog();
        }
    });

    document.getElementById('messageDialog').addEventListener('click', function(e) {
        if (e.target === this) {
            closeMessageDialog();
        }
    });
});
</script>
{% endblock %}

